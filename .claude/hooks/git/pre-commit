#!/bin/bash
# Clauder pre-commit hook
# 자동으로 문서 버전을 업데이트합니다

echo "🪝 Clauder pre-commit 훅 실행 중..."

# Python 확인
if ! command -v python3 &> /dev/null; then
    echo "⚠️  Python3가 설치되지 않아 참조 업데이트를 건너뜁니다."
    SKIP_REF_UPDATE=1
fi

# 현재 commit 해시 가져오기 (staged 상태 기준)
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "initial")
TODAY=$(date -u +"%Y-%m-%d")

# 변경된 .md 파일 찾기
MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$')

if [ -n "$MD_FILES" ]; then
    echo "📝 마크다운 파일 감지됨. 버전 메타데이터 업데이트 중..."
    
    for file in $MD_FILES; do
        if [ -f "$file" ]; then
            # 파일에 version: 섹션이 있는지 확인
            if grep -q "^version:" "$file"; then
                echo "  ✓ $file - 메타데이터 업데이트"
                # macOS와 Linux 모두 지원
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    # macOS
                    sed -i '' "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i '' "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                else
                    # Linux
                    sed -i "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                fi
                git add "$file"
            else
                echo "  ⚠️  $file - 버전 메타데이터 없음"
                echo "      다음 명령으로 추가할 수 있습니다: /clauder track add $file"
            fi
        fi
    done
fi

# 참조 업데이트 (선택적)
if [ -z "$SKIP_REF_UPDATE" ] && [ -f ".claude/scripts/reference-parser.py" ]; then
    echo "🔄 문서 참조 업데이트 중..."
    
    # 변경된 .md 파일에 대해 참조 업데이트
    for file in $MD_FILES; do
        if [ -f "$file" ]; then
            python3 .claude/scripts/reference-parser.py update "$file" > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                git add "$file"
            fi
        fi
    done
fi

# 버전 트리 동기화 (새로 추가)
if [ -f ".claude/scripts/tree-sync.py" ]; then
    echo "🌳 버전 트리 동기화 중..."
    if command -v python3 &> /dev/null; then
        # 조용히 실행, 에러 시에도 커밋은 계속
        python3 .claude/scripts/tree-sync.py > /dev/null 2>&1 || true
        
        # 트리 파일이 변경되었으면 스테이징
        if [ -f ".claude/version-tree.yaml" ] && git diff --name-only | grep -q "version-tree.yaml"; then
            git add .claude/version-tree.yaml
            echo "  ✓ 버전 트리 업데이트됨"
        fi
    fi
fi

echo "✅ Pre-commit 훅 완료"