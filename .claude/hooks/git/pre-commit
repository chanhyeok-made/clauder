#!/bin/bash

# Clauder Git pre-commit hook
# 자동으로 버전 트리 업데이트 및 문서 일관성 검증

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
CLAUDER_DEV="$PROJECT_ROOT/.clauder-dev"
VERSION_TREE="$PROJECT_ROOT/.claude/version-tree.yaml"

# 색상 정의
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}🪝 Clauder pre-commit hook 실행${NC}"

# 1. 버전 트리 자동 업데이트
if [ -x "$CLAUDER_DEV/tools/scripts/auto-update-tree.sh" ]; then
    echo -e "${YELLOW}📊 버전 트리 업데이트 중...${NC}"
    "$CLAUDER_DEV/tools/scripts/auto-update-tree.sh"
    
    # 버전 트리가 변경되었으면 스테이징에 추가
    if git diff --quiet "$VERSION_TREE"; then
        echo "버전 트리 변경 없음"
    else
        echo -e "${GREEN}✅ 버전 트리 업데이트됨${NC}"
        git add "$VERSION_TREE"
    fi
fi

# 2. doc_id 누락 확인
echo -e "${YELLOW}🔍 doc_id 검증 중...${NC}"
MISSING_DOCID=0

# 스테이징된 .md 파일들 확인
for file in $(git diff --cached --name-only --diff-filter=AM | grep '\.md$'); do
    if [ -f "$file" ] && ! grep -q "^doc_id:" "$file"; then
        echo -e "${RED}❌ doc_id 누락: $file${NC}"
        MISSING_DOCID=$((MISSING_DOCID + 1))
    fi
done

if [ $MISSING_DOCID -gt 0 ]; then
    echo -e "${RED}⚠️  $MISSING_DOCID개 파일에 doc_id가 누락되었습니다.${NC}"
    echo "버전 트리에 추가 후 다시 커밋하세요."
    exit 1
fi

# 3. 순환 참조 검사 (간단한 버전)
echo -e "${YELLOW}🔄 순환 참조 검사 중...${NC}"
# TODO: 향후 구현

# 4. 파일 관리 정책 확인
echo -e "${YELLOW}📁 임시 파일 검사 중...${NC}"
TEMP_FILES=$(git diff --cached --name-only | grep -E '(temp-|draft-)' | grep -v '.clauder-dev/temp/' || true)

if [ -n "$TEMP_FILES" ]; then
    echo -e "${YELLOW}⚠️  임시 파일이 잘못된 위치에 있습니다:${NC}"
    echo "$TEMP_FILES"
    echo "FILE-MANAGEMENT-POLICY.md를 참고하여 적절한 위치로 이동하세요."
fi

echo -e "${GREEN}✅ pre-commit 검사 완료${NC}"