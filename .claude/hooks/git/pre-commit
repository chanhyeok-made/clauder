#!/bin/bash
# Clauder pre-commit hook
# ìë™ìœ¼ë¡œ ë¬¸ì„œ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤

echo "ğŸª Clauder pre-commit í›… ì‹¤í–‰ ì¤‘..."

# í˜„ì¬ commit í•´ì‹œ ê°€ì ¸ì˜¤ê¸° (staged ìƒíƒœ ê¸°ì¤€)
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "initial")
TODAY=$(date -u +"%Y-%m-%d")

# ë³€ê²½ëœ .md íŒŒì¼ ì°¾ê¸°
MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$')

if [ -n "$MD_FILES" ]; then
    echo "ğŸ“ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê°ì§€ë¨. ë²„ì „ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."
    
    for file in $MD_FILES; do
        if [ -f "$file" ]; then
            # íŒŒì¼ì— version: ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
            if grep -q "^version:" "$file"; then
                echo "  âœ“ $file - ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸"
                # macOSì™€ Linux ëª¨ë‘ ì§€ì›
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    # macOS
                    sed -i '' "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i '' "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                else
                    # Linux
                    sed -i "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                fi
                git add "$file"
            else
                echo "  âš ï¸  $file - ë²„ì „ ë©”íƒ€ë°ì´í„° ì—†ìŒ"
                echo "      ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: /clauder track add $file"
            fi
        fi
    done
fi

echo "âœ… Pre-commit í›… ì™„ë£Œ"