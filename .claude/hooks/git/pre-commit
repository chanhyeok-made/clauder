#!/bin/bash
# Clauder pre-commit hook
# ìë™ìœ¼ë¡œ ë¬¸ì„œ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤

echo "ğŸª Clauder pre-commit í›… ì‹¤í–‰ ì¤‘..."

# Python í™•ì¸
if ! command -v python3 &> /dev/null; then
    echo "âš ï¸  Python3ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ ì°¸ì¡° ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
    SKIP_REF_UPDATE=1
fi

# í˜„ì¬ commit í•´ì‹œ ê°€ì ¸ì˜¤ê¸° (staged ìƒíƒœ ê¸°ì¤€)
COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "initial")
TODAY=$(date -u +"%Y-%m-%d")

# ë³€ê²½ëœ .md íŒŒì¼ ì°¾ê¸°
MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$')

if [ -n "$MD_FILES" ]; then
    echo "ğŸ“ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê°ì§€ë¨. ë²„ì „ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."
    
    for file in $MD_FILES; do
        if [ -f "$file" ]; then
            # íŒŒì¼ì— version: ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
            if grep -q "^version:" "$file"; then
                echo "  âœ“ $file - ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸"
                # macOSì™€ Linux ëª¨ë‘ ì§€ì›
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    # macOS
                    sed -i '' "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i '' "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                else
                    # Linux
                    sed -i "s/updated: \".*\"/updated: \"$TODAY\"/" "$file"
                    sed -i "s/commit: \".*\"/commit: \"$COMMIT_HASH\"/" "$file"
                fi
                git add "$file"
            else
                echo "  âš ï¸  $file - ë²„ì „ ë©”íƒ€ë°ì´í„° ì—†ìŒ"
                echo "      ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: /clauder track add $file"
            fi
        fi
    done
fi

# ì°¸ì¡° ì—…ë°ì´íŠ¸ (ì„ íƒì )
if [ -z "$SKIP_REF_UPDATE" ] && [ -f ".claude/scripts/reference-parser.py" ]; then
    echo "ğŸ”„ ë¬¸ì„œ ì°¸ì¡° ì—…ë°ì´íŠ¸ ì¤‘..."
    
    # ë³€ê²½ëœ .md íŒŒì¼ì— ëŒ€í•´ ì°¸ì¡° ì—…ë°ì´íŠ¸
    for file in $MD_FILES; do
        if [ -f "$file" ]; then
            python3 .claude/scripts/reference-parser.py update "$file" > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                git add "$file"
            fi
        fi
    done
fi

# ë²„ì „ íŠ¸ë¦¬ ë™ê¸°í™” (ìƒˆë¡œ ì¶”ê°€)
if [ -f ".claude/scripts/tree-sync.py" ]; then
    echo "ğŸŒ³ ë²„ì „ íŠ¸ë¦¬ ë™ê¸°í™” ì¤‘..."
    if command -v python3 &> /dev/null; then
        # ì¡°ìš©íˆ ì‹¤í–‰, ì—ëŸ¬ ì‹œì—ë„ ì»¤ë°‹ì€ ê³„ì†
        python3 .claude/scripts/tree-sync.py > /dev/null 2>&1 || true
        
        # íŠ¸ë¦¬ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ìŠ¤í…Œì´ì§•
        if [ -f ".claude/version-tree.yaml" ] && git diff --name-only | grep -q "version-tree.yaml"; then
            git add .claude/version-tree.yaml
            echo "  âœ“ ë²„ì „ íŠ¸ë¦¬ ì—…ë°ì´íŠ¸ë¨"
        fi
    fi
fi

echo "âœ… Pre-commit í›… ì™„ë£Œ"